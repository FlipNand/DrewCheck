<!-- 
  WORDPRESS EMBED INSTRUCTIONS:
  1. Add a "Custom HTML" block to your page/post.
  2. Paste this entire code snippet into the block.
  3. API Key is pre-filled.
-->

<div id="ai-cube-widget" style="position: relative; width: 100%; height: 600px; background: #050505; overflow: hidden; border-radius: 12px; font-family: 'Segoe UI', sans-serif; color: white;">

    <!-- 1. GLOBAL ERROR TRAP (Runs before anything else) -->
    <script>
        window.addEventListener('error', function(event) {
            const errorBox = document.getElementById('ai-cube-debug-console');
            if(errorBox) {
                errorBox.style.display = 'block';
                errorBox.innerHTML += '<div style="color: #ff5555; margin-bottom: 5px;">⚠️ ' + event.message + '</div>';
            }
        });
    </script>

    <style>
        /* Scoped CSS for the Widget */
        #ai-cube-widget * { box-sizing: border-box; }
        #ai-cube-canvas-container { width: 100%; height: 100%; display: block; outline: none; }
        
        /* UI Overlay */
        #ai-cube-controls {
            position: absolute; top: 20px; left: 20px; width: 280px;
            max-height: calc(100% - 40px); overflow-y: auto;
            padding: 20px; background: rgba(20, 20, 20, 0.95);
            border: 1px solid #444; border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px); z-index: 10;
            /* Visible by default so buttons are accessible even if 3D fails */
            display: block; 
        }
        #ai-cube-controls::-webkit-scrollbar { width: 6px; }
        #ai-cube-controls::-webkit-scrollbar-thumb { background-color: #444; border-radius: 3px; }
        
        #ai-cube-controls h2 {
            margin-top: 0; font-size: 1.2rem; text-transform: uppercase;
            letter-spacing: 2px; color: #ffffff; text-align: center;
            margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;
            font-family: inherit;
        }

        .ai-cube-upload-group { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .ai-cube-upload-group:last-child { border-bottom: none; }
        #ai-cube-controls label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc; font-weight: bold; }
        #ai-cube-controls input[type="file"] { display: none; }

        .ai-cube-custom-file-upload {
            display: block; padding: 10px; background: #333; color: #fff;
            border: 1px dashed #666; border-radius: 8px; text-align: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; margin-bottom: 10px;
        }
        .ai-cube-custom-file-upload:hover { background: #444; border-color: #888; }
        
        /* AI Controls */
        .ai-cube-ai-controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .ai-cube-input {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid #555; border-radius: 6px; color: white; font-size: 0.8rem;
        }
        .ai-cube-input:focus { outline: none; border-color: #8fa; }
        
        .ai-cube-btn-row { display: flex; gap: 5px; }
        .ai-cube-btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.75rem; font-weight: bold;
            transition: all 0.1s; text-transform: uppercase; color: white;
        }
        .btn-inspire { background: linear-gradient(135deg, #6e8efb, #a777e3); }
        .btn-inspire:hover { opacity: 0.9; }
        .btn-generate { background: linear-gradient(135deg, #ff9966, #ff5e62); }
        .btn-generate:hover { opacity: 0.9; }
        
        .btn-apply {
            width: 100%; padding: 8px; background: transparent;
            border: 1px solid #666; color: #aaa; border-radius: 6px;
            cursor: pointer; font-size: 0.75rem; text-transform: uppercase; transition: all 0.1s;
        }
        .btn-apply:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        .ai-cube-note { font-size: 0.75rem; color: #555; margin-top: 10px; text-align: center; font-style: italic; }

        /* Loading Overlay */
        #ai-cube-loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #ffffff;
            font-size: 1.2rem; z-index: 20; transition: opacity 0.5s;
        }
        
        /* Debug Console (Visible if errors occur) */
        #ai-cube-debug-console {
            position: absolute; bottom: 0; left: 0; width: 100%;
            max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.8);
            color: #00ffcc; padding: 10px; font-family: monospace; font-size: 10px;
            z-index: 30; pointer-events: none;
        }

        .spinner {
            display: inline-block; width: 30px; height: 30px;
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <!-- Debug Console -->
    <div id="ai-cube-debug-console">System Initializing...</div>

    <!-- Loading Screen -->
    <div id="ai-cube-loading">
        <div class="spinner"></div>
        <div id="loading-text">Loading 3D Engine...</div>
    </div>

    <!-- UI Controls -->
    <div id="ai-cube-controls">
        <h2>Cube Config</h2>
        
        <div class="ai-cube-upload-group" id="group-1">
            <label>Side 1 (Front)</label>
            <div class="ai-cube-ai-controls">
                <input type="text" class="ai-cube-input" id="prompt-1" placeholder="Describe texture or click Inspire...">
                <div class="ai-cube-btn-row">
                    <button class="ai-cube-btn btn-inspire" id="inspire-1">Inspire Me ✨</button>
                    <button class="ai-cube-btn btn-generate" id="gen-1">Generate ✨</button>
                </div>
            </div>
            <label for="upload-1" class="ai-cube-custom-file-upload" id="label-1">Or Upload Image</label>
            <input type="file" id="upload-1" accept="image/png, image/jpeg">
            <button class="btn-apply" id="btn-1">Apply to All</button>
        </div>

        <div class="ai-cube-upload-group" id="group-2">
            <label>Side 2 (Back)</label>
            <div class="ai-cube-ai-controls">
                <input type="text" class="ai-cube-input" id="prompt-2" placeholder="Describe texture...">
                <div class="ai-cube-btn-row">
                    <button class="ai-cube-btn btn-inspire" id="inspire-2">Inspire Me ✨</button>
                    <button class="ai-cube-btn btn-generate" id="gen-2">Generate ✨</button>
                </div>
            </div>
            <label for="upload-2" class="ai-cube-custom-file-upload" id="label-2">Or Upload Image</label>
            <input type="file" id="upload-2" accept="image/png, image/jpeg">
            <button class="btn-apply" id="btn-2">Apply to All</button>
        </div>

        <div class="ai-cube-upload-group" id="group-3">
            <label>Side 3 (Left)</label>
            <div class="ai-cube-ai-controls">
                <input type="text" class="ai-cube-input" id="prompt-3" placeholder="Describe texture...">
                <div class="ai-cube-btn-row">
                    <button class="ai-cube-btn btn-inspire" id="inspire-3">Inspire Me ✨</button>
                    <button class="ai-cube-btn btn-generate" id="gen-3">Generate ✨</button>
                </div>
            </div>
            <label for="upload-3" class="ai-cube-custom-file-upload" id="label-3">Or Upload Image</label>
            <input type="file" id="upload-3" accept="image/png, image/jpeg">
            <button class="btn-apply" id="btn-3">Apply to All</button>
        </div>

        <div class="ai-cube-upload-group" id="group-4">
            <label>Side 4 (Right)</label>
            <div class="ai-cube-ai-controls">
                <input type="text" class="ai-cube-input" id="prompt-4" placeholder="Describe texture...">
                <div class="ai-cube-btn-row">
                    <button class="ai-cube-btn btn-inspire" id="inspire-4">Inspire Me ✨</button>
                    <button class="ai-cube-btn btn-generate" id="gen-4">Generate ✨</button>
                </div>
            </div>
            <label for="upload-4" class="ai-cube-custom-file-upload" id="label-4">Or Upload Image</label>
            <input type="file" id="upload-4" accept="image/png, image/jpeg">
            <button class="btn-apply" id="btn-4">Apply to All</button>
        </div>

        <div class="ai-cube-note">
            Top & Bottom locked white.<br>Powered by Google Imagen
        </div>
    </div>

    <div id="ai-cube-canvas-container"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        // Using ESM.SH for strict module resolution to avoid "Module Not Found" errors
        import * as THREE from 'https://esm.sh/three@0.160.0';
        import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'https://esm.sh/three@0.160.0/examples/jsm/geometries/RoundedBoxGeometry.js';

        const apiKey = "AIzaSyAhvlt5JM8ED83nWhIT03qYiYKVDq0tL7Q"; 

        // Console helper
        function debugLog(msg) {
            const el = document.getElementById('ai-cube-debug-console');
            if(el) el.innerHTML += '<div>> ' + msg + '</div>';
            console.log(msg);
        }

        async function initApp() {
            try {
                debugLog("Script Started.");
                
                const widgetRoot = document.getElementById('ai-cube-widget');
                const container = document.getElementById('ai-cube-canvas-container');
                const loadingScreen = document.getElementById('ai-cube-loading');
                
                if (!container) throw new Error("Canvas container missing");

                // --- 3D Scene Setup ---
                debugLog("Setting up Scene...");
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x050505);
                scene.fog = new THREE.FogExp2(0x050505, 0.02);

                const camera = new THREE.PerspectiveCamera(45, widgetRoot.clientWidth / widgetRoot.clientHeight, 0.1, 100);
                camera.position.set(5, 2, 7);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.5;
                renderer.setSize(widgetRoot.clientWidth, widgetRoot.clientHeight);
                container.innerHTML = ""; // Clear any previous attempts
                container.appendChild(renderer.domElement);

                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 2.0;
                controls.minPolarAngle = Math.PI / 2;
                controls.maxPolarAngle = Math.PI / 2;

                const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(5, 5, 10);
                scene.add(dirLight);

                // --- Cube Logic ---
                const textureLoader = new THREE.TextureLoader();

                function createWhiteMaterial() {
                    return new THREE.MeshStandardMaterial({
                        color: 0xffffff, roughness: 0.1, metalness: 0.0,
                        emissive: 0xffffff, emissiveIntensity: 0.3
                    });
                }

                // 7 Materials: 0-5 for sides, 6 for white rounded frame
                const materials = Array(7).fill(null).map(createWhiteMaterial);
                const geometry = new RoundedBoxGeometry(3, 3, 3, 8, 0.4);

                // Map materials to faces
                geometry.clearGroups();
                const position = geometry.attributes.position;
                const normal = geometry.attributes.normal;
                for (let i = 0; i < position.count; i += 3) {
                    const nx = normal.getX(i); const ny = normal.getY(i); const nz = normal.getZ(i);
                    let matIndex = 6; // Default to white frame
                    if (Math.abs(nx) > 0.99) matIndex = nx > 0 ? 0 : 1;
                    else if (Math.abs(ny) > 0.99) matIndex = ny > 0 ? 2 : 3;
                    else if (Math.abs(nz) > 0.99) matIndex = nz > 0 ? 4 : 5;
                    geometry.addGroup(i, 3, matIndex);
                }

                const cube = new THREE.Mesh(geometry, materials);
                scene.add(cube);
                debugLog("Cube Added.");

                // --- Helper Functions ---
                function addWhiteBorderToImage(imageSource, callback) {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 512; canvas.height = 512;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 512, 512);
                        const border = 30; // White border thickness
                        ctx.drawImage(img, border, border, 512-(border*2), 512-(border*2));
                        callback(canvas.toDataURL('image/png'));
                    };
                    img.src = imageSource;
                }

                function applyTexture(matIndex, src) {
                    addWhiteBorderToImage(src, (finalSrc) => {
                        textureLoader.load(finalSrc, (tex) => {
                            tex.colorSpace = THREE.SRGBColorSpace;
                            tex.wrapS = THREE.ClampToEdgeWrapping;
                            tex.wrapT = THREE.ClampToEdgeWrapping;
                            cube.material[matIndex].map = tex;
                            cube.material[matIndex].color.setHex(0xffffff);
                            cube.material[matIndex].emissiveMap = tex;
                            cube.material[matIndex].emissive = new THREE.Color(0xffffff);
                            cube.material[matIndex].emissiveIntensity = 0.5;
                            cube.material[matIndex].needsUpdate = true;
                        });
                    });
                }

                function applyLoadingTexture(matIndex) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 512; canvas.height = 512;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,512,512);
                    ctx.fillStyle = '#cccccc'; 
                    for(let i=0; i<10; i++) ctx.fillRect(0, i*52, 512, 10);
                    ctx.fillStyle = '#000000'; ctx.font = 'bold 50px Arial';
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText("GENERATING...", 256, 256);
                    
                    const tex = new THREE.CanvasTexture(canvas);
                    cube.material[matIndex].map = tex;
                    cube.material[matIndex].emissiveMap = null;
                    cube.material[matIndex].needsUpdate = true;
                }

                // --- AI Logic ---
                async function getInspirePrompt() {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(url, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: "Describe a sci-fi texture in 5 words." }] }] })
                        });
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text.trim();
                    } catch (e) { return "Geometric Pattern"; }
                }

                async function generatePollinations(prompt) {
                    const seed = Math.floor(Math.random() * 100000);
                    // Use Turbo for speed
                    return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=512&height=512&model=turbo&nologo=true&seed=${seed}`;
                }

                async function generateImage(prompt) {
                    if(!apiKey) throw new Error("No API Key");
                    
                    // Try Imagen 3.0 first
                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`;
                        const response = await fetch(url, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instances: [{ prompt: prompt + " (texture)" }], parameters: { sampleCount: 1 } })
                        });
                        if(!response.ok) throw new Error("Imagen Failed");
                        const data = await response.json();
                        return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    } catch (e) {
                        debugLog("Using Backup Generator...");
                        return await generatePollinations(prompt);
                    }
                }

                // --- Setup Listeners ---
                const config = {
                    '1': { input:'upload-1', gen:'gen-1', inspire:'inspire-1', prompt:'prompt-1', btn:'btn-1', idx:4 },
                    '2': { input:'upload-2', gen:'gen-2', inspire:'inspire-2', prompt:'prompt-2', btn:'btn-2', idx:5 },
                    '3': { input:'upload-3', gen:'gen-3', inspire:'inspire-3', prompt:'prompt-3', btn:'btn-3', idx:1 },
                    '4': { input:'upload-4', gen:'gen-4', inspire:'inspire-4', prompt:'prompt-4', btn:'btn-4', idx:0 },
                };

                Object.values(config).forEach(conf => {
                    const fileIn = document.getElementById(conf.input);
                    const genBtn = document.getElementById(conf.gen);
                    const inspireBtn = document.getElementById(conf.inspire);
                    const promptIn = document.getElementById(conf.prompt);
                    const applyBtn = document.getElementById(conf.btn);

                    if(fileIn) {
                        fileIn.addEventListener('change', (e) => {
                            if(e.target.files[0]) {
                                const reader = new FileReader();
                                reader.onload = (ev) => applyTexture(conf.idx, ev.target.result);
                                reader.readAsDataURL(e.target.files[0]);
                            }
                        });
                    }

                    if(inspireBtn) {
                        inspireBtn.addEventListener('click', async () => {
                            inspireBtn.textContent = "...";
                            const txt = await getInspirePrompt();
                            promptIn.value = txt;
                            inspireBtn.textContent = "Inspire Me ✨";
                        });
                    }

                    if(genBtn) {
                        genBtn.addEventListener('click', async () => {
                            if(!promptIn.value) return alert("Enter prompt!");
                            const oldTxt = genBtn.textContent;
                            genBtn.textContent = "Busy...";
                            applyLoadingTexture(conf.idx);
                            controls.autoRotate = false;
                            
                            try {
                                const url = await generateImage(promptIn.value);
                                applyTexture(conf.idx, url);
                                setTimeout(() => controls.autoRotate = true, 3000);
                            } catch(e) { alert("Failed: " + e.message); }
                            
                            genBtn.textContent = oldTxt;
                        });
                    }
                    
                    if(applyBtn) {
                        applyBtn.addEventListener('click', () => {
                            if(cube.material[conf.idx].map) {
                                [0,1,4,5].forEach(i => {
                                    cube.material[i].map = cube.material[conf.idx].map;
                                    cube.material[i].emissiveMap = cube.material[conf.idx].map;
                                    cube.material[i].needsUpdate = true;
                                });
                                applyBtn.textContent = "Applied!";
                                setTimeout(() => applyBtn.textContent = "Apply to All", 1000);
                            } else alert("No Texture");
                        });
                    }
                });

                // --- Animation Loop ---
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                // --- Start ---
                animate();
                loadingScreen.style.opacity = 0;
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                debugLog("System Ready.");

                // Auto-hide debug after success
                setTimeout(() => {
                    const debug = document.getElementById('ai-cube-debug-console');
                    if(debug) debug.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error(err);
                const debug = document.getElementById('ai-cube-debug-console');
                if(debug) debug.innerHTML += '<div style="color:red">CRITICAL INIT ERROR: ' + err.message + '</div>';
            }
        }

        // Failsafe Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            setTimeout(initApp, 100);
        }
        
        // Safety timeout to hide loading screen if hanging
        setTimeout(() => {
            const ls = document.getElementById('ai-cube-loading');
            if(ls) ls.style.display = 'none';
        }, 3000);

    </script>
</div>
